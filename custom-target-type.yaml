apiVersion: deploy.cloud.google.com/v1
kind: CustomTargetType
metadata:
  name: helm-deployer
description: "Custom target type for Helm deployments using Cloud Deploy"
customActions:
  deploy:
    container:
      image: gcr.io/clouddeploy/helm-deployer:latest
      entrypoint: /bin/bash
      args:
        - "-c"
        - |
          echo "ğŸš€ Deploying Helm release {{.Release.Name}} to namespace {{.Target.Namespace}}"
          helm upgrade --install {{.Release.Name}} charts/sample-app \
            --namespace {{.Target.Namespace}} \
            --set image.repository={{.Images.app.repository}},image.tag={{.Images.app.tag}} \
            -f charts/sample-app/values.yaml
  rollback:
    container:
      image: gcr.io/clouddeploy/helm-deployer:latest
      entrypoint: /bin/bash
      args:
        - "-c"
        - |
          echo "ğŸ” Rolling back Helm release {{.Release.Name}}"
          helm rollback {{.Release.Name}}
